<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmere Knowledge Graph — Words of Brandon</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/theme.css">
<link rel="stylesheet" href="css/animations.css">
<link rel="stylesheet" href="css/graph.css">
<link rel="stylesheet" href="css/layout.css">
<link rel="stylesheet" href="css/components.css">
</head>
<body>

<!-- ── Loading Screen ────────────────────────────────────────── -->
<div id="loading">
  <svg id="glyph" viewBox="-100 -100 200 200" width="150" height="150">
    <circle class="glyph-ring" cx="0" cy="0" r="40"/>
    <circle class="glyph-inner" cx="0" cy="0" r="18"/>
    <path class="glyph-ray" d="M46,0 L70,0" style="animation-delay:1.0s"/>
    <path class="glyph-ray" d="M32.5,32.5 L49.5,49.5" style="animation-delay:1.05s"/>
    <path class="glyph-ray" d="M0,46 L0,70" style="animation-delay:1.1s"/>
    <path class="glyph-ray" d="M-32.5,32.5 L-49.5,49.5" style="animation-delay:1.15s"/>
    <path class="glyph-ray" d="M-46,0 L-70,0" style="animation-delay:1.2s"/>
    <path class="glyph-ray" d="M-32.5,-32.5 L-49.5,-49.5" style="animation-delay:1.25s"/>
    <path class="glyph-ray" d="M0,-46 L0,-70" style="animation-delay:1.3s"/>
    <path class="glyph-ray" d="M32.5,-32.5 L49.5,-49.5" style="animation-delay:1.35s"/>
    <circle class="glyph-dot" cx="76" cy="0" r="3" style="animation-delay:1.45s"/>
    <circle class="glyph-dot" cx="53.7" cy="53.7" r="3" style="animation-delay:1.5s"/>
    <circle class="glyph-dot" cx="0" cy="76" r="3" style="animation-delay:1.55s"/>
    <circle class="glyph-dot" cx="-53.7" cy="53.7" r="3" style="animation-delay:1.6s"/>
    <circle class="glyph-dot" cx="-76" cy="0" r="3" style="animation-delay:1.65s"/>
    <circle class="glyph-dot" cx="-53.7" cy="-53.7" r="3" style="animation-delay:1.7s"/>
    <circle class="glyph-dot" cx="0" cy="-76" r="3" style="animation-delay:1.75s"/>
    <circle class="glyph-dot" cx="53.7" cy="-53.7" r="3" style="animation-delay:1.8s"/>
  </svg>
  <div id="loading-text">Connecting the Cosmere...</div>
</div>

<!-- ── Stormlight Particles ──────────────────────────────────── -->
<canvas id="particles"></canvas>

<!-- ── Graph ─────────────────────────────────────────────────── -->
<div id="graph-container">
  <svg id="graph-svg"></svg>
</div>

<!-- ── Header ────────────────────────────────────────────────── -->
<div id="header">
  <h1 id="title">Cosmere Knowledge Graph</h1>
  <div id="subtitle">Words of Brandon</div>
  <div id="header-line"></div>
  <div id="search-box">
    <input type="text" id="search-input" placeholder='Search entities... ( / )'>
    <button id="search-clear">&times;</button>
    <div id="search-suggestions"></div>
  </div>
  <button id="guide-btn">Worldhopper's Guide</button>
</div>

<!-- ── Filters ───────────────────────────────────────────────── -->
<div id="filters"></div>

<!-- ── Embedding Controls ────────────────────────────────────── -->
<div id="embedding-controls-bar">
  <span class="bar-label">Embeddings</span>
  <button id="tuning-toggle-btn">Tune</button>
  <button id="apply-embeddings-btn">Apply</button>
  <span id="embedding-stats">Ready to compute</span>
  <div id="edge-layer-toggle">
    <span class="edge-layer-option">
      <input type="radio" name="edge-layer" id="edge-layer-explicit" value="explicit">
      <label for="edge-layer-explicit">Explicit</label>
    </span>
    <span class="edge-layer-option">
      <input type="radio" name="edge-layer" id="edge-layer-both" value="both" checked>
      <label for="edge-layer-both">Both</label>
    </span>
    <span class="edge-layer-option">
      <input type="radio" name="edge-layer" id="edge-layer-implicit" value="implicit">
      <label for="edge-layer-implicit">Implicit</label>
    </span>
  </div>
  <button id="review-toggle-btn">Review</button>
</div>

<div id="tuning-panel">
  <h3>Embedding Tuning</h3>

  <div class="tuning-row">
    <label>
      <span>Calibration Percentile</span>
      <span class="slider-value" id="value-calibration-percentile">25</span>
    </label>
    <input type="range" id="slider-calibration-percentile"
           aria-label="Calibration Percentile"
           min="10" max="50" step="5" value="25">
  </div>

  <div class="tuning-row">
    <label>
      <span>Min Specificity</span>
      <span class="slider-value" id="value-min-specificity">2.0</span>
    </label>
    <input type="range" id="slider-min-specificity"
           aria-label="Min Specificity"
           min="0" max="5" step="0.1" value="2">
  </div>

  <div class="tuning-row">
    <label>
      <span>Confidence Margin</span>
      <span class="slider-value" id="value-confidence-margin">0.05</span>
    </label>
    <input type="range" id="slider-confidence-margin"
           aria-label="Confidence Margin"
           min="0" max="0.15" step="0.01" value="0.05">
  </div>

  <div class="tuning-row">
    <label>
      <span>Min Edge Weight</span>
      <span class="slider-value" id="value-min-edge-weight">2</span>
    </label>
    <input type="range" id="slider-min-edge-weight"
           aria-label="Min Edge Weight"
           min="2" max="10" step="1" value="2">
  </div>

  <div class="tuning-checkbox-row">
    <input type="checkbox" id="checkbox-must-bridge" checked>
    <label for="checkbox-must-bridge">Must-Bridge (remove orphan tags)</label>
  </div>
</div>

<!-- ── Side Panel ────────────────────────────────────────────── -->
<div id="panel">
  <button id="panel-close">&times;</button>
  <div id="panel-content"></div>
</div>

<!-- ── Review Panel ─────────────────────────────────────────── -->
<div id="review-panel">
  <button id="review-close-btn" aria-label="Close review panel">&times;</button>
  <h3>Review Implicit Tags</h3>
  <div class="review-subtitle" id="review-subtitle">No implicit tags computed yet</div>
  <div id="review-actions">
    <button id="save-reviews-btn">Save Reviews</button>
    <button id="load-reviews-btn">Load Reviews</button>
    <select id="review-sort-select">
      <option value="score-desc">Score (high to low)</option>
      <option value="score-asc">Score (low to high)</option>
      <option value="entity-asc">Entity (A-Z)</option>
      <option value="status">Status</option>
    </select>
    <label id="review-filter-label"><input type="checkbox" id="review-filter-unreviewed"> Unreviewed only</label>
  </div>
  <div class="review-table" id="review-table"></div>
</div>

<!-- ── Guide Modal ─────────────────────────────────────────── -->
<div id="guide-overlay">
  <div id="guide-modal">
    <button id="guide-close">&times;</button>

    <div class="guide-title">Welcome, Worldhopper</div>
    <div class="guide-epigraph">"The most important step a man can take. It's not the first one, is it?<br>It's the next one. Always the next one."</div>

    <div class="guide-section">
      <p>You're looking at a map of every connection Brandon Sanderson has drawn between the people, places, and powers of the Cosmere -- built from <strong style="color:var(--stormlight)">16,282</strong> of his own answers to fan questions.</p>
      <p>Each gemstone is an entity he's discussed. Each thread between them is a connection he's made -- two topics mentioned in the same Q&amp;A. The bigger the gemstone, the more he's talked about it. Kaladin blazes large. Geranid, less so.</p>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section">
      <h3><span class="guide-gem" style="background:var(--gem-sapphire-glow)"></span>The Gemstones</h3>
      <p>Five gemstone types, five kinds of Cosmere knowledge:</p>
      <div class="gem-legend">
        <div class="gem-legend-row">
          <span class="gem-legend-dot" style="background:var(--gem-sapphire-glow)"></span>
          <span class="gem-legend-name" style="color:var(--gem-sapphire-glow)">Sapphire</span>
          <span><strong>Characters</strong> -- the people, spren, kandra, and Cognitive Shadows. <span class="gem-legend-examples">Kaladin, Hoid, Vin, Kelsier, Shallan, Nightblood...</span></span>
        </div>
        <div class="gem-legend-row">
          <span class="gem-legend-dot" style="background:var(--gem-emerald-glow)"></span>
          <span class="gem-legend-name" style="color:var(--gem-emerald-glow)">Emerald</span>
          <span><strong>Worlds</strong> -- the planets and realms. <span class="gem-legend-examples">Roshar, Scadrial, Sel, Nalthis, the Cognitive Realm...</span></span>
        </div>
        <div class="gem-legend-row">
          <span class="gem-legend-dot" style="background:var(--gem-amethyst-glow)"></span>
          <span class="gem-legend-name" style="color:var(--gem-amethyst-glow)">Amethyst</span>
          <span><strong>Magic Systems</strong> -- the Invested Arts. <span class="gem-legend-examples">Allomancy, Surgebinding, Awakening, Hemalurgy, Feruchemy...</span></span>
        </div>
        <div class="gem-legend-row">
          <span class="gem-legend-dot" style="background:var(--gem-heliodor-glow)"></span>
          <span class="gem-legend-name" style="color:var(--gem-heliodor-glow)">Heliodor</span>
          <span><strong>Shards</strong> -- the sixteen fragments of Adonalsium. <span class="gem-legend-examples">Honor, Odium, Preservation, Ruin, Endowment, Autonomy...</span></span>
        </div>
        <div class="gem-legend-row">
          <span class="gem-legend-dot" style="background:var(--gem-ruby-glow)"></span>
          <span class="gem-legend-name" style="color:var(--gem-ruby-glow)">Ruby</span>
          <span><strong>Concepts</strong> -- the underlying mechanics and lore. <span class="gem-legend-examples">Investiture, Knights Radiant, Desolations, Connection, Identity...</span></span>
        </div>
      </div>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section">
      <h3><span class="guide-gem" style="background:var(--gem-emerald-glow)"></span>Exploring the Map</h3>
      <ul>
        <li><strong style="color:var(--stormlight)">Tap a gemstone</strong> to focus on it. Everything unrelated fades, and a panel opens showing its connections and how strong each one is.</li>
        <li><strong style="color:var(--stormlight)">Tap a connection</strong> in the panel to read the actual Q&amp;A entries -- Brandon's exact words on how Nightblood relates to Vasher, or why the Cognitive Realm works differently on Sel.</li>
        <li><strong style="color:var(--stormlight)">Search</strong> (or press <span class="guide-kbd">/</span>) to jump to any entity. Start typing "Hoid" and watch the suggestions appear.</li>
        <li><strong style="color:var(--stormlight)">Filter</strong> by type to isolate what interests you. Turn off Characters to see only magic-system-to-world connections. Turn off everything except Shards to see how Adonalsium's fragments relate to each other.</li>
      </ul>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section">
      <h3><span class="guide-gem" style="background:var(--gem-heliodor-glow)"></span>Discovering Hidden Connections</h3>
      <p>The bar at the bottom labeled <strong style="color:var(--gem-heliodor-glow)">Embeddings</strong> is where things get interesting.</p>
      <p>The base graph only shows <strong>explicit</strong> connections -- entity pairs that were literally tagged together in Arcanum's database. But Brandon often discusses an entity without it being formally tagged. He might answer a question tagged only "Allomancy" but spend half the answer talking about Preservation.</p>
      <p>The embedding system reads the <em>text</em> of every Q&amp;A entry and uses AI similarity matching to find these hidden connections. Press <strong style="color:var(--gem-heliodor-glow)">Apply</strong> and new <strong>dashed amber lines</strong> appear -- connections the tags missed, but Brandon's words reveal.</p>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section">
      <h3><span class="guide-gem" style="background:var(--gem-amethyst-glow)"></span>Fine-Tuning the Discovery</h3>
      <p>Press <strong style="color:var(--gem-heliodor-glow)">Tune</strong> to control how aggressively the system discovers connections:</p>
      <table class="guide-tuning-table">
        <thead>
          <tr><th>Control</th><th>What It Does</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Calibration Percentile</td>
            <td>
              How confident do we need to be? Lower = cast a wider net. Higher = only the most obvious discoveries.
              <span class="guide-tuning-example">At 10, a Q&amp;A about "Investiture mechanics" might get tagged with Preservation. At 50, only entries that practically name-drop Preservation would qualify.</span>
            </td>
          </tr>
          <tr>
            <td>Min Specificity</td>
            <td>
              Filters out hub entities that match everything loosely. Higher values only use focused entities.
              <span class="guide-tuning-example">"Allomancy" appears in hundreds of entries and matches everything -- it gets filtered out. "Lerasium" is specific enough to produce meaningful connections.</span>
            </td>
          </tr>
          <tr>
            <td>Confidence Margin</td>
            <td>
              When multiple entities could match an entry, how close does a runner-up need to be to the top scorer?
              <span class="guide-tuning-example">An entry scores 0.82 for Preservation and 0.79 for Ruin. With margin 0.05, both pass (gap is only 0.03). With margin 0.01, only Preservation is kept.</span>
            </td>
          </tr>
          <tr>
            <td>Min Edge Weight</td>
            <td>
              How many shared entries do two entities need before we draw a connection? Higher = fewer, stronger lines.
              <span class="guide-tuning-example">At 2, a single coincidence isn't enough -- entities must co-occur at least twice.</span>
            </td>
          </tr>
          <tr>
            <td>Must-Bridge</td>
            <td>
              Only tag entries that already mention something else. Prevents orphan discoveries floating in the void.
              <span class="guide-tuning-example">An entry with no existing tags won't receive an implicit tag, since there's nothing for it to bridge to.</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section">
      <h3><span class="guide-gem" style="background:var(--gem-ruby-glow)"></span>Reviewing What Was Found</h3>
      <p>After pressing Apply, click <strong style="color:var(--gem-heliodor-glow)">Review</strong> to see every implicit tag the system discovered. You can sort by confidence score, confirm tags that look right, reject false positives, and save your reviews to a file.</p>
      <p>Use the <strong style="color:var(--stormlight)">Explicit / Both / Implicit</strong> radio toggle to switch which edge layer is visible -- see only the original graph, only the discoveries, or both overlaid.</p>
    </div>

    <div class="guide-divider"></div>

    <div class="guide-section" style="text-align:center;">
      <p style="color:rgba(200,223,255,0.3); font-family:var(--font-display); font-size:13px; font-style:italic;">Data from 16,282 Words of Brandon entries on Arcanum &middot; wob.coppermind.net</p>
    </div>
  </div>
</div>

<!-- ── Tooltip ───────────────────────────────────────────────── -->
<div id="tooltip"></div>

<!-- ── Info ───────────────────────────────────────────────────── -->
<div id="info">
  <span class="info-title">Cosmere Knowledge Graph</span> &middot;
  <span id="node-count"></span> entities &middot;
  <span id="edge-count"></span> connections &middot;
  Data from <a href="https://wob.coppermind.net/" target="_blank">Arcanum</a>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="js/tagging-engine.js"></script>
<script type="module" src="js/app.js"></script>
</body>
</html>
